generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  supabaseId String   @unique
  name       String
  email      String   @unique
  avatar     String?
  plan       PlanType @default(FREE)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  spacesCreated     Space[]            @relation("HostSpaces")
  spaceParticipants SpaceParticipant[]
  finalOutputs      FinalOutput[]
  planUsages        PlanUsage[]
}

enum PlanType {
  FREE
  PRO
  BUSINESS
}

model Space {
  id                  String          @id @default(cuid())
  hostId              String
  host                User            @relation("HostSpaces", fields: [hostId], references: [id])
  coHostId            String?
  title               String
  description         String?
  joinCode            String          @unique
  status              SpaceStatus     @default(LIVE)
  recordingStatus     RecordingStatus @default(IDLE)
  startTime           DateTime?
  endTime             DateTime?
  duration            Int? // seconds
  planUsed            PlanType        @default(FREE)
  totalRecordingHours Float?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  participants SpaceParticipant[]
  recordings   Recording[]
  finalOutputs FinalOutput[]
}

enum SpaceStatus {
  LIVE // meeting active, users connected
  ENDED // host ended meeting
  PROCESSING // backend merging recordings
  READY // meeting + final output ready
}

enum RecordingStatus {
  IDLE // recording not started
  RECORDING // recording active
  STOPPED // recording stopped
}

model SpaceParticipant {
  id           String          @id @default(cuid())
  spaceId      String
  space        Space           @relation(fields: [spaceId], references: [id])
  userId       String
  user         User            @relation(fields: [userId], references: [id])
  role         ParticipantRole
  joinedAt     DateTime        @default(now())
  leftAt       DateTime?
  hasRecording Boolean         @default(false)
  recordings   Recording[]
}

enum ParticipantRole {
  HOST
  CO_HOST
  GUEST
}

model Recording {
  id            String              @id @default(cuid())
  spaceId       String
  space         Space               @relation(fields: [spaceId], references: [id])
  participantId String
  participant   SpaceParticipant    @relation(fields: [participantId], references: [id])
  type          RecordingType
  chunks        Json // list of uploaded chunk URLs
  fileUrl       String? // final single track file (webm/mp4)
  status        RecordingFileStatus @default(UPLOADING)
  startTime     DateTime
  endTime       DateTime
  duration      Int // in seconds
  quality       QualityType         @default(P720)
  localUpload   Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

enum RecordingType {
  AUDIO
  VIDEO
}

enum RecordingFileStatus {
  UPLOADING
  UPLOADED
  MERGED
}

enum QualityType {
  P720
  P1080
  P4K
}

model FinalOutput {
  id               String       @id @default(cuid())
  spaceId          String
  space            Space        @relation(fields: [spaceId], references: [id])
  hostId           String
  host             User         @relation(fields: [hostId], references: [id])
  mergedAt         DateTime     @default(now())
  status           OutputStatus @default(PROCESSING)
  mixedUrl         String? // merged AV file
  audioOnly        String?
  individualTracks Json? // for pro users (unlocked)
  duration         Int? // seconds
  quality          QualityType  @default(P1080)
  createdAt        DateTime     @default(now())
}

enum OutputStatus {
  PROCESSING
  READY
}

model PlanUsage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  month     String // e.g. "2025-11"
  hoursUsed Float    @default(0)
  hoursCap  Float
  createdAt DateTime @default(now())
}
